<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Formulário de Currículo Popular Atacarejo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ======= VARIÁVEIS E ESTILOS GLOBAIS ======= */
    :root {
      --bg-light: #f8fafc; --text-light: #1e293b;
      --accent-light: #059669; --accent-light-hover: #047857;
      --secondary-light: #10b981; --secondary-light-hover: #059669;
      --focus-ring-light: #dc2626; --error-light: #dc2626; --success-light: #059669;
      --border-light: #e2e8f0; --shadow-light: rgba(0,0,0,.05);
      --input-bg-light: #fff; --input-text-light: #475569;
      --card-bg-light: #ffffff; --legend-text-light: #64748b;
      --step-bg-light: #f8fafc;
      --header-bg-light: linear-gradient(135deg, #059669 0%, #10b981 100%);

      --bg-dark: #0f172a; --text-dark: #f1f5f9;
      --accent-dark: #10b981; --accent-dark-hover: #059669;
      --secondary-dark: #34d399; --secondary-dark-hover: #10b981;
      --focus-ring-dark: #ef4444; --error-dark: #f87171; --success-dark: #34d399;
      --border-dark: #334155; --shadow-dark: rgba(255,255,255,.05);
      --input-bg-dark: #1e293b; --input-text-dark: #cbd5e1; 
      --card-bg-dark: #1e293b; --legend-text-dark: #94a3b8;
      --step-bg-dark: #1e293b;
      --header-bg-dark: linear-gradient(135deg, #047857 0%, #059669 100%);

      --bg: var(--bg-light); --text: var(--text-light); --accent: var(--accent-light);
      --accent-hover: var(--accent-light-hover); --focus-ring: var(--focus-ring-light);
      --error-color: var(--error-light); --success-color: var(--success-light);
      --border: var(--border-light); --shadow: var(--shadow-light);
      --input-bg: var(--input-bg-light); --input-text: var(--input-text-light);
      --card-bg: var(--card-bg-light); --legend-text: var(--legend-text-light);
      --step-bg: var(--step-bg-light);
      --header-bg: var(--header-bg-light);
      --transition-speed: .3s;
      --border-radius: 16px;
      --card-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      --header-height: 180px;
    }
    
    [data-theme='dark'] {
      --bg: var(--bg-dark); --text: var(--text-dark); --accent: var(--accent-dark);
      --accent-hover: var(--accent-dark-hover); --focus-ring: var(--focus-ring-dark);
      --error-color: var(--error-dark); --success-color: var(--success-dark);
      --border: var(--border-dark); --shadow: var(--shadow-dark);
      --input-bg: var(--input-bg-dark); --input-text: var(--input-text-dark);
      --card-bg: var(--card-bg-dark); --legend-text: var(--legend-text-dark);
      --step-bg: var(--step-bg-dark);
      --header-bg: var(--header-bg-dark);
      --card-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0;
    }
    
    body {
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg); 
      color: var(--text); 
      line-height: 1.6;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      transition: background-color var(--transition-speed), color var(--transition-speed);
      padding: 0;
    }
    
    .app-container {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      position: relative;
    }
    
    .header {
      background: var(--header-bg);
      color: white;
      padding: 2rem 2rem 1.5rem;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.3;
    }
    
    .header-content {
      position: relative;
      z-index: 1;
    }
    
    h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      letter-spacing: -0.5px;
    }
    
    .header-subtitle {
      font-size: 1rem;
      opacity: 0.9;
      margin-bottom: 1.5rem;
      font-weight: 400;
    }
    
    .form-container {
      width: 100%;
      margin-top: -40px;
      position: relative;
      z-index: 2;
    }
    
    form {
      background: var(--card-bg);
      padding: 2.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      animation: fadeInUp .8s ease-out;
      transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
      margin: 0 1.5rem 2rem;
    }
    
    .form-description {
      text-align: center;
      color: var(--text);
      opacity: .8;
      margin-bottom: 1.5rem;
      font-size: .95rem;
      transition: color var(--transition-speed);
      max-width: 90%;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.6;
    }
    
    fieldset {
      border: none;
      margin-bottom: 2.5rem;
      padding: 0;
      border-radius: var(--border-radius);
      background: var(--step-bg);
      padding: 1.5rem;
      transition: all var(--transition-speed);
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    
    fieldset::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--accent);
      border-radius: 4px 0 0 4px;
    }
    
    fieldset[aria-disabled="true"] {
      opacity: .6;
      filter: grayscale(.1);
    }
    
    legend {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--legend-text);
      margin-bottom: 1.5rem;
      padding-bottom: .75rem;
      border-bottom: 1px solid var(--border);
      width: 100%;
      transition: color var(--transition-speed), border-color var(--transition-speed);
      display: flex;
      align-items: center;
    }
    
    .legend-icon {
      margin-right: 10px;
      font-size: 1.2rem;
      color: var(--accent);
      width: 24px;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
      position: relative;
    }
    
    label {
      display: block;
      margin-bottom: .5rem;
      font-weight: 500;
      font-size: .9rem;
      color: var(--text);
      transition: color var(--transition-speed);
    }
    
    .input-with-icon {
      position: relative;
    }
    
    .input-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--legend-text);
      z-index: 1;
    }
    
    input[type="text"],
    input[type="email"],
    input[type="file"],
    select {
      width: 100%;
      padding: .8rem 1rem .8rem 2.5rem;
      margin-top: .25rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--input-text);
      font-size: .95rem;
      transition: all var(--transition-speed);
      outline: none;
      min-height: 44px;
    }
    
    input::placeholder,
    select::placeholder {
      color: var(--input-text);
      opacity: .7;
    }
    
    input:focus,
    select:focus {
      border-color: var(--focus-ring);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--focus-ring) 20%, transparent);
      transform: translateY(-1px);
    }
    
    input[type="file"] {
      padding: .5rem 1rem .5rem 2.5rem;
    }
    
    input[type="file"]::file-selector-button {
      margin-right: 1rem;
      border: none;
      background: var(--accent);
      padding: .6rem 1rem;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      transition: all var(--transition-speed);
      font-weight: 500;
    }
    
    input[type="file"]::file-selector-button:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    
    button[type="submit"] {
      background: var(--accent);
      color: #fff;
      padding: .9rem 1.5rem;
      margin-top: 1.5rem;
      width: 100%;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-speed);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: .5rem;
      box-shadow: 0 4px 15px color-mix(in srgb, var(--accent) 40%, transparent);
      position: relative;
      overflow: hidden;
    }
    
    button[type="submit"]:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px color-mix(in srgb, var(--accent) 50%, transparent);
    }
    
    button[type="submit"]:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 4px 15px color-mix(in srgb, var(--accent) 40%, transparent);
    }
    
    button[type="submit"]:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      opacity: .7;
      box-shadow: none;
      transform: none;
    }
    
    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .message {
      display: none;
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
      font-weight: 500;
      animation: fadeIn .5s ease-out;
    }
    
    .message.success {
      background: color-mix(in srgb, var(--success-color) 15%, transparent);
      color: var(--success-color);
      border: 1px solid color-mix(in srgb, var(--success-color) 30%, transparent);
    }
    
    .message.error {
      background: color-mix(in srgb, var(--error-color) 15%, transparent);
      color: var(--error-color);
      border: 1px solid color-mix(in srgb, var(--error-color) 30%, transparent);
    }
    
    .hidden {
      display: none !important;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== STEPPER MELHORADO ====== */
    .stepper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin: 1.5rem 0 1.25rem;
      flex-wrap: wrap;
      position: relative;
    }
    
    .step {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: .75rem;
      z-index: 1;
    }
    
    .step .dot {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      background: color-mix(in srgb, var(--accent) 15%, var(--card-bg));
      color: var(--accent);
      font-weight: 700;
      border: 2px solid color-mix(in srgb, var(--accent) 35%, transparent);
      transition: all var(--transition-speed);
      position: relative;
      font-size: 1rem;
    }
    
    .step .label {
      font-size: .9rem;
      color: var(--legend-text);
      font-weight: 500;
      transition: color var(--transition-speed);
      text-align: center;
    }
    
    .step.done .dot {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    
    .step.active .dot {
      box-shadow: 0 0 0 6px color-mix(in srgb, var(--accent) 20%, transparent);
      background: var(--accent);
      color: #fff;
    }
    
    .step.disabled .dot {
      opacity: .5;
      background: color-mix(in srgb, var(--border) 30%, var(--card-bg));
      color: var(--border);
      border-color: var(--border);
    }
    
    .step.disabled .label {
      color: var(--border);
    }
    
    .stepbar {
      position: absolute;
      top: 22px;
      left: 10%;
      right: 10%;
      height: 4px;
      background: color-mix(in srgb, var(--border) 60%, transparent);
      border-radius: 999px;
      z-index: 0;
    }
    
    .stepbar > .fill {
      height: 100%;
      width: 0;
      background: var(--accent);
      border-radius: 999px;
      transition: width .3s ease;
    }
    
    /* Barra de progresso discreta */
    .wakebar {
      height: 3px;
      width: 0;
      background: var(--accent);
      border-radius: 999px;
      transition: width .2s;
      margin-bottom: 1.5rem;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 1.5rem;
      color: var(--legend-text);
      font-size: 0.85rem;
    }
    
    .theme-toggle {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }
    
    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(30deg);
    }
    
    /* ====== RESPONSIVIDADE ====== */
    @media (max-width: 1200px) {
      .app-container { max-width: 860px; }
    }
    
    @media (max-width: 992px) {
      .app-container { max-width: 740px; }
      form { padding: 2rem; }
    }
    
    @media (max-width: 768px) {
      body { padding: 0; }
      .app-container { margin: 0; }
      .header { padding: 1.5rem 1.5rem 1rem; }
      h1 { font-size: 1.5rem; }
      .header-subtitle { font-size: 0.9rem; }
      form { padding: 1.5rem; margin: 0 1rem 1.5rem; }
      .form-description { font-size: .95rem; margin-bottom: 1.25rem; }
      legend { font-size: 1rem; margin-bottom: 1rem; }
      .form-group { margin-bottom: 1rem; }
      label { font-size: .92rem; }
      input[type="text"], input[type="email"], input[type="file"], select, button[type="submit"] { 
        font-size: 1rem; 
        padding: .85rem 1rem .85rem 2.5rem; 
      }
      input[type="file"]::file-selector-button { padding: .6rem .9rem; }
      .stepper { flex-wrap: wrap; gap: .5rem; }
      .step .label { font-size: .85rem; }
      fieldset { padding: 1.25rem; }
      .step .dot { width: 36px; height: 36px; }
      .stepbar { top: 18px; }
    }
    
    @media (max-width: 560px) {
      :root { --transition-speed: .25s; }
      h1 { font-size: 1.3rem; }
      .header-subtitle { font-size: 0.85rem; }
      .form-description { font-size: .9rem; }
      .stepper { gap: .25rem; }
      .step .dot { width: 32px; height: 32px; font-size: .85rem; }
      .step .label { display: none; }
      .stepbar { height: 3px; top: 16px; }
      input[type="text"], input[type="email"], input[type="file"], select { font-size: 1rem; }
      #submitButton.sticky-submit { 
        position: sticky; 
        bottom: 1rem; 
        z-index: 10; 
        margin-top: 1rem;
      }
      fieldset { padding: 1rem; margin-bottom: 1.5rem; }
      .theme-toggle { top: 1rem; right: 1rem; width: 36px; height: 36px; }
    }
    
    @media (max-width: 390px) {
      form { padding: 1.25rem; margin: 0 0.5rem 1.5rem; }
      .form-group { margin-bottom: .85rem; }
      input[type="text"], input[type="email"], input[type="file"], select { padding: .75rem .9rem .75rem 2.2rem; }
      input[type="file"]::file-selector-button { padding: .5rem .8rem; }
      fieldset { padding: 1rem; margin-bottom: 1.25rem; }
    }
  </style>
</head>
<body data-theme="light">
  <div class="app-container">
    <button class="theme-toggle" id="themeToggle">
      <i class="fas fa-moon"></i>
    </button>
    
    <div class="header">
      <div class="header-content">
       <h1>Quer Fazer Parte da Equipe Popular Atacrejo</h1>
<p class="header-subtitle">Envie suas informações e mostre por que você é a pessoa certa para esta vaga.</p>
      </div>
    </div>

    <div class="form-container">
      <form id="formCurriculo" novalidate>
        <div class="wakebar" id="wakebar" aria-hidden="true"></div>

        <!-- Stepper melhorado -->
        <div class="stepper" aria-hidden="true">
          <div class="step" id="step1Head">
            <span class="dot">1</span>
            <span class="label">Pessoais</span>
          </div>
          <div class="step" id="step2Head">
            <span class="dot">2</span>
            <span class="label">Endereço</span>
          </div>
          <div class="step" id="step3Head">
            <span class="dot">3</span>
            <span class="label">Candidatura</span>
          </div>
          <div class="stepbar" aria-hidden="true">
            <div class="fill" id="stepFill"></div>
          </div>
        </div>

        <!-- ETAPA 1 - Informações Pessoais -->
        <fieldset id="fs1">
          <legend>
            <i class="fas fa-user legend-icon"></i>
            Informações Pessoais
          </legend>
          <div class="form-group">
            <label for="nome">Nome Completo:</label>
            <div class="input-with-icon">
              <i class="fas fa-user input-icon"></i>
              <input type="text" id="nome" name="nome" required placeholder="Digite seu nome completo">
            </div>
          </div>
          <div class="form-group">
            <label for="cpf">CPF:</label>
            <div class="input-with-icon">
              <i class="fas fa-id-card input-icon"></i>
              <input type="text" id="cpf" name="cpf" required placeholder="000.000.000-00">
            </div>
          </div>
          <div class="form-group">
            <label for="telefone">Telefone:</label>
            <div class="input-with-icon">
              <i class="fas fa-phone input-icon"></i>
              <input type="text" id="telefone" name="telefone" required placeholder="(00) 00000-0000">
            </div>
          </div>
          <div class="form-group">
            <label for="email">Email:</label>
            <div class="input-with-icon">
              <i class="fas fa-envelope input-icon"></i>
              <input type="email" id="email" name="email" required placeholder="seuemail@exemplo.com">
            </div>
          </div>
        </fieldset>

        <!-- ETAPA 2 - Endereço -->
        <fieldset id="fs2" aria-disabled="true" disabled>
          <legend>
            <i class="fas fa-home legend-icon"></i>
            Endereço
          </legend>
          <div class="form-group">
            <label for="cep">CEP:</label>
            <div class="input-with-icon">
              <i class="fas fa-map-pin input-icon"></i>
              <input type="text" id="cep" name="cep" required placeholder="00000-000">
            </div>
          </div>
          <div class="form-group">
            <label for="cidade">Cidade:</label>
            <div class="input-with-icon">
              <i class="fas fa-city input-icon"></i>
              <input type="text" id="cidade" name="cidade" required placeholder="Sua cidade">
            </div>
          </div>
          <div class="form-group">
            <label for="bairro">Bairro:</label>
            <div class="input-with-icon">
              <i class="fas fa-map input-icon"></i>
              <input type="text" id="bairro" name="bairro" required placeholder="Seu bairro">
            </div>
          </div>
          <div class="form-group">
            <label for="rua">Rua:</label>
            <div class="input-with-icon">
              <i class="fas fa-road input-icon"></i>
              <input type="text" id="rua" name="rua" required placeholder="Nome da sua rua">
            </div>
          </div>
        </fieldset>

        <!-- ETAPA 3 - Candidatura -->
        <fieldset id="fs3" aria-disabled="true" disabled>
          <legend>
            <i class="fas fa-briefcase legend-icon"></i>
            Candidatura
          </legend>
          <div class="form-group">
            <label for="transporte">Possui Transporte Próprio?</label>
            <div class="input-with-icon">
              <i class="fas fa-car input-icon"></i>
              <select id="transporte" name="transporte" required>
                <option value="" disabled selected>Selecione...</option>
                <option>Sim</option>
                <option>Não</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="vaga">Vaga Desejada:</label>
            <div class="input-with-icon">
              <i class="fas fa-briefcase input-icon"></i>
              <select id="vaga" name="vaga" required>
                <option value="" disabled selected>Carregando vagas...</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="arquivo">Anexar Currículo (PDF/DOC/DOCX):</label>
            <div class="input-with-icon">
              <i class="fas fa-file-upload input-icon"></i>
              <input type="file" id="arquivo" name="arquivo" accept=".pdf,.doc,.docx" required>
            </div>
          </div>
        </fieldset>

        <button type="submit" id="submitButton" class="sticky-submit" disabled>
          <span class="button-text">Enviar Candidatura</span>
          <span class="spinner hidden"></span>
        </button>

        <div class="message success hidden" id="mensagemSucesso"></div>
        <div class="message error hidden" id="mensagemErro"></div>
      </form>
    </div>

    <div class="footer">
      <p>© 2025 Popular Atacarejo e Home Center, Sistema de Candidatura. Todos os direitos reservados.</p>
    </div>
  </div>

  <script src="https://unpkg.com/imask"></script>
  <script>
    // ====== CONFIG ======
    const API_BASE = "https://formulariobk.onrender.com";
    const FILE_MAX_MB = 5;
    const WAKE_MS = 30000;

    // ====== DOM ======
    const form = document.getElementById("formCurriculo");
    const fs1 = document.getElementById('fs1');
    const fs2 = document.getElementById('fs2');
    const fs3 = document.getElementById('fs3');
    const themeToggle = document.getElementById('themeToggle');

    const nome = document.getElementById("nome");
    const cpf = document.getElementById("cpf");
    const telefone = document.getElementById("telefone");
    const email = document.getElementById("email");
    const cep = document.getElementById("cep");
    const cidade = document.getElementById("cidade");
    const bairro = document.getElementById("bairro");
    const rua = document.getElementById("rua");
    const transporte = document.getElementById("transporte");
    const vaga = document.getElementById("vaga");
    const arquivo = document.getElementById("arquivo");

    const btn = document.getElementById("submitButton");
    const btnText = btn.querySelector(".button-text");
    const spinner = btn.querySelector(".spinner");
    const okBox = document.getElementById("mensagemSucesso");
    const errBox = document.getElementById("mensagemErro");
    const wakebar = document.getElementById("wakebar");

    const stepFill = document.getElementById('stepFill');
    const step1Head = document.getElementById('step1Head');
    const step2Head = document.getElementById('step2Head');
    const step3Head = document.getElementById('step3Head');

    // ====== Toggle de Tema ======
    themeToggle.addEventListener('click', () => {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', newTheme);
      
      // Atualizar ícone do botão
      const icon = themeToggle.querySelector('i');
      if (newTheme === 'dark') {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
      } else {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
      }
    });

    // ====== Máscaras ======
    IMask(cpf, { mask: "000.000.000-00" });
    IMask(cep, { mask: "00000-000" });
    IMask(telefone, { mask: [{mask:"(00) 0000-0000"}, {mask:"(00) 00000-0000"}] });

    // ====== ViaCEP (debounce) ======
    let cepTimer;
    cep.addEventListener("input", ()=>{
      clearTimeout(cepTimer);
      cepTimer = setTimeout(async ()=>{
        const v = cep.value.replace(/\D/g,"");
        if(v.length !== 8) return;
        try{
          const r = await fetch(`https://viacep.com.br/ws/${v}/json/`, { cache:"no-store" });
          if(!r.ok) return;
          const d = await r.json();
          if(!d?.erro){
            cidade.value = d.localidade || "";
            bairro.value = d.bairro || "";
            rua.value = d.logradouro || "";
          }
          updateSteps();
        }catch{}
      }, 500);
    });

    // ====== Util ======
    function showMsg(el, msg){
      el.textContent = msg;
      el.classList.remove("hidden");
      el.style.display = "block";
      if(el === okBox){ errBox.classList.add("hidden"); errBox.style.display="none"; }
      else { okBox.classList.add("hidden"); okBox.style.display="none"; }
    }
    function hideMsgs(){
      [okBox, errBox].forEach(e => { e.classList.add("hidden"); e.style.display="none"; });
    }
    function setLoading(v){
      if(v){ btnText.classList.add("hidden"); spinner.classList.remove("hidden"); btn.disabled = true; }
      else { btnText.classList.remove("hidden"); spinner.classList.add("hidden"); }
    }
    function validateFile(){
      const f = arquivo.files?.[0];
      if(!f){ showMsg(errBox, "Selecione um arquivo."); return false; }
      const ok = ["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"];
      if(!ok.includes(f.type)){ showMsg(errBox, "Formato inválido. Envie PDF, DOC ou DOCX."); return false; }
      if(f.size > FILE_MAX_MB*1024*1024){ showMsg(errBox, `Arquivo muito grande. Máximo ${FILE_MAX_MB} MB.`); return false; }
      return true;
    }
    function orderedFD(){
      const out = new FormData();
      out.append("nome", nome.value);
      out.append("cpf", cpf.value);
      out.append("telefone", telefone.value);
      out.append("email", email.value);
      out.append("cep", cep.value);
      out.append("cidade", cidade.value);
      out.append("bairro", bairro.value);
      out.append("rua", rua.value);
      out.append("transporte", transporte.value);
      out.append("vaga", vaga.value);
      out.append("arquivo", arquivo.files[0]);
      out.append("data", new Date().toISOString());
      return out;
    }
    async function fetchWithTimeout(url, opts={}, ms=30000){
      const ctrl = new AbortController(); 
      const t = setTimeout(()=>{
        if (!ctrl.signal.aborted) {
          ctrl.abort();
        }
      }, ms);
      try{ 
        const response = await fetch(url, { 
          ...opts, 
          signal: ctrl.signal, 
          cache:"no-store",
          headers: {
            ...opts.headers,
            'User-Agent': 'CurriculoForm/1.0'
          }
        });
        return response;
      } finally{ 
        clearTimeout(t); 
      }
    }
    function animateWake(ms){
      const bar = wakebar; bar.style.width = "0%";
      const start = performance.now();
      const step = (now)=>{
        const p = Math.min(1, (now - start)/ms);
        bar.style.width = (p*100).toFixed(1) + "%";
        if(p<1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }
    async function preWake(){
      animateWake(WAKE_MS);
      const start = Date.now();
      while(Date.now() - start < WAKE_MS){
        try{ const r = await fetchWithTimeout(`${API_BASE}/health`, {}, 5000); if(r.ok){ wakebar.style.width="100%"; return true; } }catch{}
        await new Promise(r => setTimeout(r, 3000));
      }
      return false;
    }

    // ====== Carregar vagas do Supabase ======
    async function loadVagas() {
      try {
        const response = await fetchWithTimeout(`${API_BASE}/api/vagas`, {}, 30000); // 30 segundos
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        
        const vagas = await response.json();
        const selectVaga = document.getElementById('vaga');
        
        // Limpar options atuais
        selectVaga.innerHTML = '<option value="" disabled selected>Selecione a vaga...</option>';
        
        // Adicionar vagas do banco
        vagas.forEach(vaga => {
          const option = document.createElement('option');
          option.value = vaga.nome;
          option.textContent = vaga.nome;
          selectVaga.appendChild(option);
        });
        
        // Atualizar validação das etapas
        updateSteps();
        
      } catch (error) {
        console.error('Erro ao carregar vagas:', error);
        const selectVaga = document.getElementById('vaga');
        
        if (error.name === 'AbortError') {
          selectVaga.innerHTML = '<option value="" disabled selected>Servidor ocupado. Tente recarregar a página.</option>';
        } else {
          selectVaga.innerHTML = '<option value="" disabled selected>Erro ao carregar vagas. Recarregue a página.</option>';
        }
        
        // Forçar atualização do estado do formulário
        updateSteps();
      }
    }

    // ====== Validação por etapa ======
    const reqStep1 = [nome, cpf, telefone, email];
    const reqStep2 = [cep, cidade, bairro, rua];
    const reqStep3 = [transporte, vaga, arquivo];

    function isFilled(input){
      if(input.type === 'email') return /.+@.+\..+/.test(input.value.trim());
      if(input.tagName === 'SELECT') return !!input.value;
      if(input.type === 'file') return !!input.files?.length;
      return input.value.trim().length > 0;
    }

    function setFsDisabled(fieldset, disabled){
      if(disabled){
        fieldset.setAttribute('disabled','');
        fieldset.setAttribute('aria-disabled','true');
      }else{
        fieldset.removeAttribute('disabled');
        fieldset.setAttribute('aria-disabled','false');
      }
    }

    function markStep(head, state){
      head.classList.remove('disabled','active','done');
      head.classList.add(state); // 'disabled' | 'active' | 'done'
    }

    function updateSteps(){
      const s1ok = reqStep1.every(isFilled);
      const s2ok = s1ok && reqStep2.every(isFilled);
      const s3ok = s2ok && reqStep3.every(isFilled);

      setFsDisabled(fs2, !s1ok);
      setFsDisabled(fs3, !s2ok);

      // stepper states
      markStep(step1Head, s1ok ? 'done' : 'active');
      markStep(step2Head, s1ok ? (s2ok ? 'done' : 'active') : 'disabled');
      markStep(step3Head, s2ok ? (s3ok ? 'done' : 'active') : 'disabled');

      // barra de progresso das etapas (0%, 50%, 100%)
      const pct = s1ok ? (s2ok ? (s3ok ? 100 : 66) : 33) : 0;
      stepFill.style.width = pct + '%';

      // botão
      btn.disabled = !s3ok;
    }

    // Event listeners para atualização das etapas
    [...reqStep1, ...reqStep2, transporte, arquivo].forEach(el => {
      const evt = el.type === 'file' ? 'change' : 'input';
      el.addEventListener(evt, updateSteps);
    });

    // Event listener específico para o select de vaga
    vaga.addEventListener('change', updateSteps);

    // ====== Inicializar ======
    document.addEventListener('DOMContentLoaded', function() {
      loadVagas(); // Carregar vagas quando a página carregar
      updateSteps(); // Inicializar steps
    });

    // ====== Submit ======
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideMsgs();

      // garante regras da etapa 3
      if(!validateFile()){ updateSteps(); return; }

      setLoading(true);

      // acorda o Render (até 30s)
      const woke = await preWake();
      if(!woke){ setLoading(false); showMsg(errBox,"Estamos processando sua solicitação. Por favor, aguarde alguns instantes até que sua candidatura seja enviada."); return; }

      // Envia
      let resp, data = {};
      try{
        resp = await fetchWithTimeout(`${API_BASE}/api/enviar`, { method:"POST", body: orderedFD() }, 60000);
        try{ data = await resp.json(); }catch{}
      }catch{
        setLoading(false);
        showMsg(errBox,"Falha de rede ao enviar. Tente novamente.");
        return;
      }

      setLoading(false);

      if(resp.status === 409){
        showMsg(errBox, data?.message || "Identificamos que já existe uma candidatura registrada para esta vaga com o mesmo CPF. Aguarde o período estabelecido antes de reenviar");
        return;
      }
      if(!resp.ok){
        const txt = data?.message || (await resp.text().catch(()=>null)) || "Não foi possível enviar sua candidatura.";
        showMsg(errBox, txt);
        return;
      }

      showMsg(okBox, data?.message || "Sua candidatura foi enviada com sucesso. Agradecemos seu interesse e entraremos em contato caso seu perfil seja selecionado.");
      form.reset();
      wakebar.style.width = "0%";
      updateSteps();
    });
  </script>
</body>
</html>
